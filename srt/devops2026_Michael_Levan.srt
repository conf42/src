1
00:00:00,000 --> 00:00:01,470
Speaker 19: What is going on everybody?

2
00:00:01,470 --> 00:00:07,650
My name is Michael Lavan, and I'd like
to welcome you to Conf 42 DevOps 2026.

3
00:00:08,039 --> 00:00:14,880
So in this session, what we're gonna do is
we are going to talk about all things cost

4
00:00:14,910 --> 00:00:21,210
around LLMs, around AI in general, and
all the traffic that you may be sending

5
00:00:21,210 --> 00:00:27,090
from an agent to an LLM or an agent to an
MCP server, or an agent to another agent.

6
00:00:27,290 --> 00:00:31,460
We're gonna see how we can not only route
all that traffic through an AI gateway

7
00:00:31,460 --> 00:00:36,680
using agent Gateway, but we're actually
going to see the cost, the breakdown,

8
00:00:36,920 --> 00:00:41,870
what model is used and everything from
a metrics perspective within Grafana.

9
00:00:42,080 --> 00:00:43,460
So let's go ahead and jump on in.

10
00:00:43,545 --> 00:00:47,445
Okay, so the first thing that we want to
do is we want to make sure we have agent

11
00:00:47,445 --> 00:00:49,785
Gateway installed, which I already did.

12
00:00:49,815 --> 00:00:53,445
I can go ahead, run this command,
and then we can see that output here.

13
00:00:53,835 --> 00:00:57,825
Now the next thing that we want to do is
we want to figure out what LLM provider

14
00:00:57,825 --> 00:01:00,675
we want to use to route traffic to, right?

15
00:01:00,675 --> 00:01:04,305
Again, whether it's via an agent, whether
we're just going directly through the

16
00:01:04,305 --> 00:01:05,835
gateway, however we want to do it.

17
00:01:06,104 --> 00:01:07,395
We need an LLM provider.

18
00:01:07,574 --> 00:01:10,514
So in this case I'm gonna use Anthropic
just 'cause that's where I have a

19
00:01:10,514 --> 00:01:15,255
subscription, but any LLM provider
will work just fine in this case.

20
00:01:15,375 --> 00:01:18,675
Now I've already set my anthropic
key, so what I can do is I can

21
00:01:18,675 --> 00:01:22,815
create a Kubernetes secret that's
pointing to the Anthropic API Key.

22
00:01:23,315 --> 00:01:27,395
All right, so now what we're gonna do
is we're gonna create three gateways,

23
00:01:27,395 --> 00:01:30,845
and it doesn't matter if you create one
or two or 10 or 20, it doesn't matter.

24
00:01:30,995 --> 00:01:35,225
I'm just using three because I feel like
it's a good number to showcase all the

25
00:01:35,225 --> 00:01:37,265
costs and how we can put it all together.

26
00:01:37,505 --> 00:01:39,365
But again, if you're using one.

27
00:01:39,420 --> 00:01:41,040
20 doesn't matter.

28
00:01:41,100 --> 00:01:45,150
Alright, so to break this down,
I'm gonna create a gateway object.

29
00:01:45,180 --> 00:01:49,980
And this is of course coming from the
Kubernetes gateway, API CRDs, right?

30
00:01:50,010 --> 00:01:54,780
And I'm gonna name it agent gateway one,
and then I'm gonna have three gateways.

31
00:01:54,780 --> 00:01:56,730
So there's gonna be agent
gateway one, two, and three.

32
00:01:56,820 --> 00:01:57,150
Alright?

33
00:01:57,450 --> 00:02:01,350
I'm gonna use the agent gateway class,
and then I'm just gonna allow traffic

34
00:02:01,350 --> 00:02:03,449
from all name spaces for testing purposes.

35
00:02:03,549 --> 00:02:06,669
Next what we're gonna do is we're
gonna create an agent gateway.

36
00:02:06,879 --> 00:02:07,629
Backend.

37
00:02:07,689 --> 00:02:12,279
And this backend is how the gateway
itself knows what to route to.

38
00:02:12,489 --> 00:02:16,570
So in this case, I'm routing to a
clawed model, but I could also be

39
00:02:16,570 --> 00:02:18,669
routing to an MCP server, for example.

40
00:02:18,760 --> 00:02:22,809
Alright, and then last, but certainly
not least, is the HTP route.

41
00:02:22,959 --> 00:02:26,679
That way we have an endpoint that
we can actually route to, right?

42
00:02:27,099 --> 00:02:31,390
And as you can see here, I'm
referencing the gateway and then I'm

43
00:02:31,390 --> 00:02:33,640
referencing the agent gateway backend.

44
00:02:33,880 --> 00:02:36,640
Now the other thing that
I'm doing is I'm replacing.

45
00:02:37,015 --> 00:02:43,015
The slash V one slash chat slash
completions path with slash anthropic.

46
00:02:43,104 --> 00:02:43,675
Why?

47
00:02:43,825 --> 00:02:48,115
Just because slash anthropic is
a lot easier to type than slash v

48
00:02:48,115 --> 00:02:50,515
one slash chat slash completions.

49
00:02:50,515 --> 00:02:50,844
Okay.

50
00:02:51,055 --> 00:02:54,625
Now one thing I will say is if you're
wondering hey Mike, I thought you

51
00:02:54,625 --> 00:02:59,005
were routing to Claude, so shouldn't
it be slash V one slash messages?

52
00:02:59,245 --> 00:03:04,045
This path here would be considered
part of the OpenAI API format

53
00:03:04,045 --> 00:03:05,845
spec, which Claude supports.

54
00:03:05,845 --> 00:03:07,135
So it's totally fine.

55
00:03:07,135 --> 00:03:08,515
This will work as expected.

56
00:03:08,725 --> 00:03:12,475
That way we can route to it and we
can even curl it to see that it works.

57
00:03:12,715 --> 00:03:13,855
So I'm gonna go ahead.

58
00:03:13,855 --> 00:03:16,075
I'm gonna create this gateway here.

59
00:03:16,575 --> 00:03:20,625
Alright, and then I'm going to
create the gateway for the second

60
00:03:20,625 --> 00:03:22,245
gateway and the third gateway.

61
00:03:22,275 --> 00:03:25,905
And again, this is the, it's
literally the same configuration

62
00:03:25,905 --> 00:03:28,485
pointing to the same LLM, all that.

63
00:03:28,545 --> 00:03:32,325
I'm just using three gateways so
we can see the cost breakdown and

64
00:03:32,325 --> 00:03:33,795
how the cost can come together.

65
00:03:34,295 --> 00:03:34,685
Okay.

66
00:03:34,685 --> 00:03:37,355
Now the next thing that we want to
do is we want to send some traffic

67
00:03:37,355 --> 00:03:40,745
to our gateways and we want to see
that they actually work as expected.

68
00:03:40,805 --> 00:03:44,705
Alright, so I'm gonna export the
IP addresses and put them into

69
00:03:44,705 --> 00:03:49,025
environment variables of all of
the A LB ips for the gateways.

70
00:03:49,025 --> 00:03:51,365
All right, so we have Aging
gateway one, aging gateway

71
00:03:51,365 --> 00:03:52,640
two, and Aging gateway three.

72
00:03:53,140 --> 00:03:53,380
All right.

73
00:03:53,380 --> 00:03:55,930
And we can see those three
IP addresses pop up there.

74
00:03:55,930 --> 00:03:59,800
Again, those are the a LB
public IPS for the gateway.

75
00:04:00,490 --> 00:04:05,410
Alright, so now let's actually test
the gateway configuration here.

76
00:04:05,410 --> 00:04:05,770
All right.

77
00:04:05,770 --> 00:04:09,610
And what we'll do is we will
curl each ingress gateway.

78
00:04:09,850 --> 00:04:13,169
That way we can also send some
traffic to it as well, right?

79
00:04:13,169 --> 00:04:15,329
So I'm gonna curl the first one here.

80
00:04:15,829 --> 00:04:19,370
Then I'll go ahead and
curl the second one.

81
00:04:19,870 --> 00:04:24,370
All right, and then I'll go
ahead and curl the third one.

82
00:04:24,520 --> 00:04:28,030
And this will allow us to actually
generate some metrics, right?

83
00:04:28,030 --> 00:04:30,760
So like when we curl to the
gateways, we can generate metrics.

84
00:04:30,760 --> 00:04:33,975
That way we can actually see those
metrics within the Grafana dashboard.

85
00:04:34,620 --> 00:04:38,430
Alright, now the next piece of the
puzzle is to install Q Prometheus.

86
00:04:38,430 --> 00:04:41,849
And if you're not familiar with Q
Prometheus, it's a pretty cool project.

87
00:04:41,849 --> 00:04:46,020
It's as the name sounds
like Prometheus and Grafana.

88
00:04:46,110 --> 00:04:48,810
But the cool thing is you get a lot
of dashboards out of the box for

89
00:04:48,840 --> 00:04:51,990
Kubernetes, whereas if you were just
installing Grafana and Prometheus,

90
00:04:52,170 --> 00:04:53,400
you wouldn't have any dashboards.

91
00:04:53,400 --> 00:04:55,260
So I do like typically to install.

92
00:04:55,315 --> 00:04:56,305
Q Prometheus.

93
00:04:56,575 --> 00:04:57,655
All right, so I'm gonna go ahead.

94
00:04:57,655 --> 00:05:02,185
I'm going to install it on my cluster, and
now that it's installed, what I'm gonna

95
00:05:02,185 --> 00:05:04,495
do is I have two new terminals open here.

96
00:05:04,495 --> 00:05:09,315
I'm gonna go ahead and pour forward
to Prometheus, and then I am also

97
00:05:09,345 --> 00:05:12,225
going to port forward to Grafana.

98
00:05:12,915 --> 00:05:13,275
All right?

99
00:05:13,395 --> 00:05:17,085
And then what we can do
is we can open up Grafana.

100
00:05:17,085 --> 00:05:19,395
That way we can just get logged in.

101
00:05:19,895 --> 00:05:20,114
Speaker 20: All

102
00:05:20,119 --> 00:05:20,189
Speaker 19: right.

103
00:05:20,189 --> 00:05:23,939
And then admin, and we just
gotta pull the secret here.

104
00:05:23,939 --> 00:05:28,039
So I'm gonna go ahead, run this
command to get the secret right.

105
00:05:28,219 --> 00:05:29,599
Copy that.

106
00:05:30,349 --> 00:05:31,484
Paste this in.

107
00:05:31,984 --> 00:05:32,794
Okay, cool.

108
00:05:32,794 --> 00:05:34,384
So now we are in Grafana.

109
00:05:34,444 --> 00:05:38,704
Let me zoom in a little bit, and
if I go to the dashboards here, we

110
00:05:38,704 --> 00:05:41,914
can see all the dashboards that are
already available out of the box.

111
00:05:42,244 --> 00:05:44,764
But we're gonna need to do two things.

112
00:05:44,914 --> 00:05:47,374
We're gonna have to set up some
monitors, and then we're gonna

113
00:05:47,374 --> 00:05:48,604
have to set up our dashboard.

114
00:05:48,804 --> 00:05:53,124
Okay, so as you can see here, I
have a couple of different monitors

115
00:05:53,454 --> 00:05:56,904
and they are all the pod monitors
for the gateways that we deploy.

116
00:05:57,084 --> 00:05:57,384
Okay?

117
00:05:57,594 --> 00:06:02,094
So as you can see, the name is Agent
Gateway one Pod monitor, right?

118
00:06:02,094 --> 00:06:06,444
And then you can see that it's
listening for Agent Gateway one.

119
00:06:06,444 --> 00:06:08,874
And that's our gateway
that was deployed, right?

120
00:06:08,874 --> 00:06:12,144
So if I run Cube, CTL,
get Gateway, namespace.

121
00:06:12,644 --> 00:06:14,834
Aging gateway system, right?

122
00:06:14,834 --> 00:06:16,994
We can see aging gateway
one, two, and three.

123
00:06:17,174 --> 00:06:21,244
Actually have to do a quick update
here, and that's because we used

124
00:06:21,244 --> 00:06:22,714
to deploy to K gateway system.

125
00:06:22,714 --> 00:06:26,254
Now we deploy to aging gateway
system, and then you can see that it's

126
00:06:26,254 --> 00:06:31,954
listening on slash metrics and it's
pulling the metrics every 30 seconds.

127
00:06:32,914 --> 00:06:35,734
And then again, we do this
for Agent Gateway one.

128
00:06:35,884 --> 00:06:39,694
Agent gateway two, and
Agent gateway three.

129
00:06:40,294 --> 00:06:45,534
All right, so I'm gonna run QCTL
apply minus F agent gateway,

130
00:06:45,534 --> 00:06:49,765
O-S-S-K-S, cost and monitoring dl.

131
00:06:50,265 --> 00:06:52,125
All right, so those are deployed here.

132
00:06:53,115 --> 00:06:56,385
And then now what I'm gonna do is I'm
just gonna go and send a little bit

133
00:06:56,385 --> 00:06:59,805
more traffic through my gateways, right?

134
00:06:59,805 --> 00:07:00,975
Some traffic is sent.

135
00:07:01,335 --> 00:07:06,075
Now what I'm gonna do is I'm gonna go
into Grafana and I'm going to implement

136
00:07:06,075 --> 00:07:09,855
this dashboard that I created, and
this is a custom dashboard for all

137
00:07:09,855 --> 00:07:11,595
the costs and the metrics and such.

138
00:07:11,805 --> 00:07:14,325
But if you want, you just
need to go to my GitHub.

139
00:07:14,619 --> 00:07:17,559
Go to this path here, and then
you can import the dashboard

140
00:07:17,559 --> 00:07:20,530
yourself as well, if you'd like
to use it in your own environment.

141
00:07:21,030 --> 00:07:23,520
Okay, so I'm gonna go
back over to Grafana.

142
00:07:23,550 --> 00:07:25,860
I'm gonna say new import.

143
00:07:26,360 --> 00:07:27,050
Oops, sorry.

144
00:07:27,050 --> 00:07:28,490
New import.

145
00:07:28,580 --> 00:07:29,000
Okay.

146
00:07:29,030 --> 00:07:33,320
And then I'm going to specify
my path to my dashboard.

147
00:07:33,560 --> 00:07:34,880
Okay, perfect.

148
00:07:35,270 --> 00:07:40,280
So now I'm gonna say import and we
can now officially see the cost.

149
00:07:41,219 --> 00:07:47,730
Per gateway and for all of our gateways
together, and luckily I haven't spent

150
00:07:47,730 --> 00:07:50,430
too much money, so I am still in budget.

151
00:07:50,849 --> 00:07:55,409
And if you want, what you can do is you
can actually go to Prometheus as well.

152
00:07:55,909 --> 00:08:00,680
And if you type Agent Gateway, you'll
see all the different metrics available.

153
00:08:00,769 --> 00:08:06,039
So if I wanted to see, token usage, for
example, I can see token usage based

154
00:08:06,039 --> 00:08:11,619
on what gateway I sent the request to
the model and where it originated from.

155
00:08:11,649 --> 00:08:16,149
And that's how you can begin to
track your costs for any AG agentic

156
00:08:16,149 --> 00:08:17,919
traffic using Agent Gateway.

157
00:08:18,129 --> 00:08:18,939
Thank you so much for watching.

